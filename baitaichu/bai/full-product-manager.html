<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>äº§å“ç®¡ç†ç³»ç»Ÿ</title>
    <style>
        /* å…¨å±€æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* å¤´éƒ¨æ ·å¼ */
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #1890ff;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* æ ‡ç­¾é¡µæ ·å¼ */
        .nav-tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
        }
        
        .tab.active {
            color: #1890ff;
            background-color: #f0f7ff;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #1890ff;
        }
        
        /* æ ‡ç­¾å†…å®¹æ ·å¼ */
        .tab-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-height: 400px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* äº§å“å¡ç‰‡æ ·å¼ */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background-color: #f5f5f5;
        }
        
        .product-info {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .product-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .product-details div {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .product-actions {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #fafafa;
            border-top: 1px solid #e8e8e8;
        }
        
        .action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background-color: #1890ff;
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #40a9ff;
        }
        
        .delete-btn {
            background-color: #ff4d4f;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #ff7875;
        }
        
        /* åŠŸèƒ½æŒ‰é’®æ ·å¼ */
        .function-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #40a9ff;
        }
        
        .btn-danger {
            background-color: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #ff7875;
        }
        
        /* æœç´¢æ ·å¼ */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1890ff;
        }
        
        /* æ¨¡æ€æ¡†æ ·å¼ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1890ff;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* ç©ºçŠ¶æ€æ ·å¼ */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* åˆ†é¡µæ ·å¼ */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-item {
            padding: 5px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-item:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .page-item.active {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .page-item.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* å›¾ç‰‡ä¸Šä¼ æ ·å¼ */
        .image-upload-container {
            border: 2px dashed #d9d9d9;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .image-upload-container:hover {
            border-color: #1890ff;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            display: block;
            margin: 0 auto;
        }
        
        /* éšè—æ–‡ä»¶è¾“å…¥ */
        .image-upload-container input[type="file"] {
            display: none;
        }
        
        /* ä»·æ ¼ä¿¡æ¯æ ·å¼ */
        .cost-price {
            color: #ff4d4f;
            font-weight: 500;
        }
        
        .declare-price {
            color: #52c41a;
            font-weight: 500;
        }
        
        /* åˆ©æ¶¦çŠ¶æ€æ ·å¼ */
        .profit-high {
            background-color: #f6ffed;
            color: #52c41a;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .profit-medium {
            background-color: #fffbe6;
            color: #faad14;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .profit-low {
            background-color: #fff2f0;
            color: #ff4d4f;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* æ´»åŠ¨ä»·æ ¼åŒºåŸŸ */
        .activity-price-section {
            background-color: #fff7e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        /* ä¿ƒé”€éƒ¨åˆ† */
        .promotion-section {
            background-color: #f6ffed;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        /* ç¼–è¾‘è¾“å…¥æ¡† */
        .edit-input {
            width: 80px;
            padding: 2px 6px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* åˆ©æ¶¦è®¡ç®—å®¹å™¨ */
        .profit-calculation-container {
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* æ–‡ä»¶ä¸Šä¼ å®¹å™¨ */
        .file-upload-container {
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        
        .file-upload-container:hover {
            border-color: #1890ff;
            background-color: #f0f7ff;
        }
        
        /* é«˜çº§æ“ä½œ */
        .advanced-actions {
            display: flex;
            gap: 10px;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .function-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* ç»“æœè¡¨æ ¼æ ·å¼ */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .result-table th,
        .result-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .result-table th {
            background-color: #fafafa;
            font-weight: 500;
        }
        
        .summary-row {
            background-color: #f0f7ff;
            font-weight: 500;
        }
        
        .positive-profit {
            color: #52c41a;
        }
        
        .negative-profit {
            color: #ff4d4f;
        }
        
        /* æ±‡æ€»ç»Ÿè®¡ */
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 4px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            display: block;
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }
        
        .profit-positive {
            color: #52c41a;
        }
        
        .profit-negative {
            color: #ff4d4f;
        }
        
        .data-notice {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>äº§å“ç®¡ç†ç³»ç»Ÿ</h1>
            <p>å…¨é¢çš„äº§å“ç®¡ç†ã€æ´»åŠ¨æ¨å¹¿è®¡ç®—å’Œåˆ©æ¶¦æ ¸ç®—å·¥å…·</p>
        </div>
        
        <div class="nav-tabs">
            <div class="tab active" data-target="product-management">äº§å“ç®¡ç†</div>
            <div class="tab" data-target="promotion-calculation">æ´»åŠ¨æ¨å¹¿è®¡ç®—</div>
            <div class="tab" data-target="profit-calculation">åˆ©æ¶¦æ ¸ç®—</div>
        </div>
        
        <div class="tab-content">
            <!-- äº§å“ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="product-management" class="tab-pane active">
                <div class="function-buttons">
                    <div>
                        <button class="btn btn-primary add-product-btn">æ·»åŠ äº§å“</button>
                    </div>
                    <div class="advanced-actions">
                        <button class="btn">æ’åº</button>
                        <button class="btn btn-primary">å¯¼å‡º</button>
                        <button class="btn btn-primary">å¯¼å…¥</button>
                        <button class="btn btn-danger">æ‰¹é‡åˆ é™¤</button>
                    </div>
                </div>
                
                <div class="search-row">
                    <input type="text" class="search-input" placeholder="æœç´¢äº§å“åç§°ã€å…³é”®è¯...">
                    <button class="btn btn-primary">æœç´¢</button>
                </div>
                
                <div class="products-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“¦</div>
                        <p>æš‚æ— äº§å“æ•°æ®</p>
                        <button class="btn btn-primary add-product-btn">æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“</button>
                    </div>
                </div>
                
                <div class="pagination" style="display: none;">
                    <div class="page-item prev disabled">ä¸Šä¸€é¡µ</div>
                    <div class="page-item active">1</div>
                    <div class="page-item next">ä¸‹ä¸€é¡µ</div>
                </div>
            </div>
            
            <!-- æ´»åŠ¨æ¨å¹¿è®¡ç®—æ ‡ç­¾é¡µ -->
            <div id="promotion-calculation" class="tab-pane">
                <div class="function-buttons">
                    <div>
                        <button class="btn btn-primary add-product-btn">æ·»åŠ äº§å“</button>
                    </div>
                    <div class="advanced-actions">
                        <button class="btn">æ’åº</button>
                        <button id="export-promotion-btn" class="btn btn-primary">å¯¼å‡º</button>
                        <button id="import-promotion-btn" class="btn btn-primary">å¯¼å…¥</button>
                        <button class="btn btn-danger">æ‰¹é‡åˆ é™¤</button>
                    </div>
                </div>
                
                <div class="search-row">
                    <input type="text" class="search-input" placeholder="æœç´¢äº§å“åç§°ã€å…³é”®è¯...">
                    <button class="btn btn-primary">æœç´¢</button>
                    <input type="text" class="img-search-input" placeholder="å›¾ç‰‡æœç´¢" disabled>
                    <button class="btn btn-primary">å›¾ç‰‡æœç´¢</button>
                </div>
                
                <div class="products-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>æš‚æ— äº§å“æ•°æ®</p>
                        <button class="btn btn-primary add-product-btn">æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“</button>
                    </div>
                </div>
            </div>
            
            <!-- åˆ©æ¶¦æ ¸ç®—æ ‡ç­¾é¡µ -->
            <div id="profit-calculation" class="tab-pane">
                <div class="function-buttons">
                    <div>
                        <button id="import-profit-btn" class="btn btn-primary">å¯¼å…¥Excel</button>
                    </div>
                    <div class="advanced-actions">
                        <button id="export-result-btn" class="btn btn-primary">å¯¼å‡ºç»“æœ</button>
                        <button id="clear-result-btn" class="btn btn-danger">æ¸…ç©ºç»“æœ</button>
                    </div>
                </div>
                
                <div class="file-upload-container" id="excel-dropzone">
                    <div class="empty-state-icon">ğŸ“</div>
                    <p>ç‚¹å‡»æˆ–æ‹–æ‹½Excelæ–‡ä»¶åˆ°æ­¤å¤„è¿›è¡Œå¯¼å…¥</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">æ”¯æŒ.xlsxå’Œ.xlsæ ¼å¼ï¼Œæ–‡ä»¶éœ€åŒ…å«SKUå’Œæ”¶å…¥é‡‘é¢åˆ—</p>
                </div>
                
                <div id="calculation-result" class="profit-calculation-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">ğŸ“Š</div>
                        <p>è¯·å¯¼å…¥Excelæ–‡ä»¶è¿›è¡Œåˆ©æ¶¦è®¡ç®—</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- æ·»åŠ äº§å“æ¨¡æ€æ¡† -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">æ·»åŠ äº§å“</h2>
                <button class="close-btn">Ã—</button>
            </div>
            
            <div class="image-upload-container" id="add-product-image-upload">
                <input type="file" id="add-product-image-input" accept="image/*">
                <div id="add-product-image-preview"></div>
                <p>ç‚¹å‡»ä¸Šä¼ äº§å“å›¾ç‰‡</p>
            </div>
            
            <div class="form-group">
                <label for="add-product-name">äº§å“åç§°</label>
                <input type="text" id="add-product-name" placeholder="è¯·è¾“å…¥äº§å“åç§°">
            </div>
            
            <div class="form-group">
                <label for="add-product-spu">SPU</label>
                <input type="text" id="add-product-spu" placeholder="è¯·è¾“å…¥SPU">
            </div>
            
            <div class="form-group">
                <label for="add-product-skc">SKC</label>
                <input type="text" id="add-product-skc" placeholder="è¯·è¾“å…¥SKC">
            </div>
            
            <div class="form-group">
                <label for="add-product-sku">SKU</label>
                <input type="text" id="add-product-sku" placeholder="è¯·è¾“å…¥SKU">
            </div>
            
            <div class="form-group">
                <label for="add-product-category">åˆ†ç±»</label>
                <select id="add-product-category">
                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    <option value="æœè£…">æœè£…</option>
                    <option value="ç”µå­äº§å“">ç”µå­äº§å“</option>
                    <option value="å®¶å±…">å®¶å±…</option>
                    <option value="é£Ÿå“">é£Ÿå“</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="add-product-cost-price">è¿›è´§ä»·æ ¼</label>
                <input type="number" id="add-product-cost-price" placeholder="è¯·è¾“å…¥è¿›è´§ä»·æ ¼" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-declare-price">ç”³æŠ¥ä»·æ ¼</label>
                <input type="number" id="add-product-declare-price" placeholder="è¯·è¾“å…¥ç”³æŠ¥ä»·æ ¼" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-ad-bid-ratio">å¹¿å‘Šå‡ºä»·æ¯”ä¾‹</label>
                <input type="number" id="add-product-ad-bid-ratio" placeholder="è¯·è¾“å…¥å¹¿å‘Šå‡ºä»·æ¯”ä¾‹" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-description">æè¿°</label>
                <textarea id="add-product-description" rows="3" placeholder="è¯·è¾“å…¥äº§å“æè¿°"></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn close-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="save-product-btn">ä¿å­˜</button>
            </div>
        </div>
    </div>
    
    <!-- ç¼–è¾‘äº§å“æ¨¡æ€æ¡† -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">ç¼–è¾‘äº§å“</h2>
                <button class="close-btn">Ã—</button>
            </div>
            
            <div class="image-upload-container" id="edit-product-image-upload">
                <input type="file" id="edit-product-image-input" accept="image/*">
                <div id="edit-product-image-preview"></div>
                <p>ç‚¹å‡»ä¸Šä¼ äº§å“å›¾ç‰‡</p>
            </div>
            
            <div class="form-group">
                <label for="edit-product-name">äº§å“åç§°</label>
                <input type="text" id="edit-product-name" placeholder="è¯·è¾“å…¥äº§å“åç§°">
            </div>
            
            <div class="form-group">
                <label for="edit-product-spu">SPU</label>
                <input type="text" id="edit-product-spu" placeholder="è¯·è¾“å…¥SPU">
            </div>
            
            <div class="form-group">
                <label for="edit-product-skc">SKC</label>
                <input type="text" id="edit-product-skc" placeholder="è¯·è¾“å…¥SKC">
            </div>
            
            <div class="form-group">
                <label for="edit-product-sku">SKU</label>
                <input type="text" id="edit-product-sku" placeholder="è¯·è¾“å…¥SKU">
            </div>
            
            <div class="form-group">
                <label for="edit-product-category">åˆ†ç±»</label>
                <select id="edit-product-category">
                    <option value="">è¯·é€‰æ‹©åˆ†ç±»</option>
                    <option value="æœè£…">æœè£…</option>
                    <option value="ç”µå­äº§å“">ç”µå­äº§å“</option>
                    <option value="å®¶å±…">å®¶å±…</option>
                    <option value="é£Ÿå“">é£Ÿå“</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="edit-product-cost-price">è¿›è´§ä»·æ ¼</label>
                <input type="number" id="edit-product-cost-price" placeholder="è¯·è¾“å…¥è¿›è´§ä»·æ ¼" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-declare-price">ç”³æŠ¥ä»·æ ¼</label>
                <input type="number" id="edit-product-declare-price" placeholder="è¯·è¾“å…¥ç”³æŠ¥ä»·æ ¼" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-ad-bid-ratio">å¹¿å‘Šå‡ºä»·æ¯”ä¾‹</label>
                <input type="number" id="edit-product-ad-bid-ratio" placeholder="è¯·è¾“å…¥å¹¿å‘Šå‡ºä»·æ¯”ä¾‹" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-description">æè¿°</label>
                <textarea id="edit-product-description" rows="3" placeholder="è¯·è¾“å…¥äº§å“æè¿°"></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn close-btn">å–æ¶ˆ</button>
                <button class="btn btn-primary" id="update-product-btn">æ›´æ–°</button>
            </div>
        </div>
    </div>
    
    <script>
        // æ•°æ®åº“é…ç½®
        const DB_NAME = 'ProductManagementDB';
        const DB_VERSION = 5;
        const STORES = {
            PRODUCTS: 'products',
            CATEGORIES: 'categories'
        };
        
        // æ‰“å¼€æ•°æ®åº“è¿æ¥
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('æ‰“å¼€æ•°æ®åº“å¤±è´¥:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    console.log('æ•°æ®åº“æ‰“å¼€æˆåŠŸ');
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('æ•°æ®åº“ç‰ˆæœ¬å‡çº§:', event.oldVersion, '->', event.newVersion);
                    const db = event.target.result;
                    const transaction = event.target.transaction;
                    
                    // è·å–æ—§ç‰ˆæœ¬å·
                    const oldVersion = event.oldVersion;
                    
                    // å¦‚æœæ˜¯æ–°ç‰ˆæœ¬ï¼Œåˆ›å»ºç»“æ„
                    if (oldVersion < 1) {
                        // åˆ›å»ºäº§å“å­˜å‚¨
                        if (!db.objectStoreNames.contains(STORES.PRODUCTS)) {
                            const productStore = db.createObjectStore(STORES.PRODUCTS, { keyPath: 'id', autoIncrement: true });
                            productStore.createIndex('name', 'name', { unique: false });
                            productStore.createIndex('sku', 'sku', { unique: false });
                            productStore.createIndex('category', 'category', { unique: false });
                        }
                        
                        // åˆ›å»ºåˆ†ç±»å­˜å‚¨
                        if (!db.objectStoreNames.contains(STORES.CATEGORIES)) {
                            const categoryStore = db.createObjectStore(STORES.CATEGORIES, { keyPath: 'id', autoIncrement: true });
                            categoryStore.createIndex('name', 'name', { unique: true });
                        }
                    }
                    
                    // ç‰ˆæœ¬5: æ·»åŠ æ–°ç´¢å¼•
                    if (oldVersion < 5) {
                        const productStore = transaction.objectStore(STORES.PRODUCTS);
                        
                        try {
                            // æ£€æŸ¥ç´¢å¼•æ˜¯å¦å·²å­˜åœ¨ï¼Œé¿å…é‡å¤åˆ›å»º
                            if (!productStore.indexNames.contains('costPrice')) {
                                productStore.createIndex('costPrice', 'costPrice', { unique: false });
                                console.log('å·²åˆ›å»ºcostPriceç´¢å¼•');
                            }
                            
                            if (!productStore.indexNames.contains('declarePrice')) {
                                productStore.createIndex('declarePrice', 'declarePrice', { unique: false });
                                console.log('å·²åˆ›å»ºdeclarePriceç´¢å¼•');
                            }
                            
                            if (!productStore.indexNames.contains('adBidRatio')) {
                                productStore.createIndex('adBidRatio', 'adBidRatio', { unique: false });
                                console.log('å·²åˆ›å»ºadBidRatioç´¢å¼•');
                            }
                        } catch (error) {
                            console.warn('ç´¢å¼•åˆ›å»ºè­¦å‘Š:', error);
                        }
                    }
                };
            });
        }
        
        // è·å–æ‰€æœ‰äº§å“
        function getAllProducts() {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readonly');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.getAll();
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            });
        }
        
        // ä¿å­˜äº§å“
        function saveProduct(product) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    
                    const request = product.id ? store.put(product) : store.add(product);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        // å¦‚æœæ˜¯æ–°å¢äº§å“ï¼Œå°†idæ·»åŠ åˆ°äº§å“å¯¹è±¡ä¸­
                        if (!product.id) {
                            product.id = request.result;
                        }
                        resolve(product);
                    };
                });
            });
        }
        
        // åˆ é™¤äº§å“
        function deleteProduct(id) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.delete(id);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            });
        }
        
        // æ‰¹é‡åˆ é™¤äº§å“
        function deleteProducts(ids) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    
                    // åˆ é™¤æ¯ä¸ªäº§å“
                    ids.forEach(id => {
                        store.delete(id);
                    });
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            });
        }
        
        // é€šè¿‡IDè·å–äº§å“
        function getProductById(id) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readonly');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.get(id);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            });
        }
        
        // æœç´¢äº§å“
        function searchProducts(keyword) {
            return getAllProducts().then(products => {
                return products.filter(product => {
                    const searchText = `${product.name || ''} ${product.sku || ''} ${product.spu || ''} ${product.skc || ''}`.toLowerCase();
                    return searchText.includes(keyword.toLowerCase());
                });
            });
        }
        
        // å¯¼å‡ºäº§å“æ•°æ®
        function exportProducts() {
            return getAllProducts().then(products => {
                const exportData = products.map(product => ({
                    'äº§å“åç§°': product.name,
                    'SPU': product.spu,
                    'SKC': product.skc,
                    'SKU': product.sku,
                    'åˆ†ç±»': product.category,
                    'è¿›è´§ä»·æ ¼': product.costPrice,
                    'ç”³æŠ¥ä»·æ ¼': product.declarePrice,
                    'å¹¿å‘Šå‡ºä»·æ¯”ä¾‹': product.adBidRatio,
                    'æè¿°': product.description
                }));
                
                return exportData;
            });
        }
        
        // è®¡ç®—äº§å“æŒ‡æ ‡
        function calculateProductMetrics(product) {
            const declarePrice = parseFloat(product.declarePrice) || 0;
            const costPrice = parseFloat(product.costPrice) || 0;
            const adBidRatio = parseFloat(product.adBidRatio) || 1;
            
            // å¹¿å‘Šæ‰£è´¹
            const adFee = adBidRatio > 0 ? (declarePrice / adBidRatio).toFixed(2) : '0.00';
            
            // æ¨å¹¿ååˆ©æ¶¦
            const promotionProfit = (declarePrice - parseFloat(adFee) - costPrice).toFixed(2);
            
            // 95æŠ˜å”®ä»·
            const sellPrice95 = (declarePrice * 0.95).toFixed(2);
            
            // 95æŠ˜åˆ©æ¶¦
            const profit95 = (parseFloat(sellPrice95) - costPrice).toFixed(2);
            
            // 95æŠ˜åˆ©æ¶¦ç‡
            const profitRate95 = sellPrice95 > 0 ? ((profit95 / sellPrice95) * 100).toFixed(1) : '0.0';
            
            return {
                adFee,
                promotionProfit,
                sellPrice95,
                profit95,
                profitRate95
            };
        }
        
        // æ ‡ç­¾é¡µåˆ‡æ¢åŠŸèƒ½
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-target');
                    
                    // ç§»é™¤æ‰€æœ‰æ´»åŠ¨çŠ¶æ€
                    tabs.forEach(t => t.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // æ·»åŠ å½“å‰æ´»åŠ¨çŠ¶æ€
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');
                    
                    // åˆå§‹åŒ–å¯¹åº”é¡µé¢
                    if (target === 'product-management') {
                        initProductManagement();
                    } else if (target === 'promotion-calculation') {
                        initPromotionCalculation();
                    } else if (target === 'profit-calculation') {
                        initProfitCalculation();
                    }
                });
            });
        }
        
        // äº§å“ç®¡ç†é¡µé¢åˆå§‹åŒ–
        function initProductManagement() {
            console.log('åˆå§‹åŒ–äº§å“ç®¡ç†é¡µé¢');
            loadProducts();
            bindEvents();
        }
        
        // åŠ è½½äº§å“åˆ—è¡¨
        function loadProducts() {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><p>åŠ è½½ä¸­...</p></div>';
            
            getAllProducts().then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“¦</div>
                            <p>æš‚æ— äº§å“æ•°æ®</p>
                            <button class="btn btn-primary add-product-btn">æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“</button>
                        </div>
                    `;
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('åŠ è½½äº§å“å¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // åˆ›å»ºäº§å“å¡ç‰‡
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.id = product.id;
            
            // è®¡ç®—åˆ©æ¶¦çŠ¶æ€
            const profit = (parseFloat(product.declarePrice) || 0) - (parseFloat(product.costPrice) || 0);
            const profitRate = (parseFloat(product.declarePrice) || 0) > 0 ? (profit / parseFloat(product.declarePrice)) * 100 : 0;
            let profitStatusClass = 'profit-medium';
            let profitStatusText = 'ä¸­ç­‰';
            
            if (profitRate >= 50) {
                profitStatusClass = 'profit-high';
                profitStatusText = 'é«˜';
            } else if (profitRate <= 20) {
                profitStatusClass = 'profit-low';
                profitStatusText = 'ä½';
            }
            
            card.innerHTML = `
                <img src="${product.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${product.name || 'äº§å“å›¾ç‰‡'}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name || 'æœªå‘½åäº§å“'}</div>
                    <div class="product-details">
                        <div><span>SKU:</span> <span>${product.sku || '-'}</span></div>
                        <div><span>SPU:</span> <span>${product.spu || '-'}</span></div>
                        <div><span>SKC:</span> <span>${product.skc || '-'}</span></div>
                        <div><span>åˆ†ç±»:</span> <span>${product.category || 'æœªåˆ†ç±»'}</span></div>
                        <div><span>è¿›è´§ä»·æ ¼:</span> <span class="cost-price">Â¥${product.costPrice || '0.00'}</span></div>
                        <div><span>ç”³æŠ¥ä»·æ ¼:</span> <span class="declare-price">Â¥${product.declarePrice || '0.00'}</span></div>
                        <div><span>å¹¿å‘Šå‡ºä»·æ¯”ä¾‹:</span> <span>${product.adBidRatio || '0'}</span></div>
                        <div><span>åˆ©æ¶¦çŠ¶æ€:</span> <span class="${profitStatusClass}">${profitStatusText}</span></div>
                    </div>
                </div>
                <div class="product-actions">
                    <button class="action-btn edit-btn" data-action="edit">ç¼–è¾‘</button>
                    <button class="action-btn" data-action="copy">å¤åˆ¶</button>
                    <button class="action-btn delete-btn" data-action="delete">åˆ é™¤</button>
                </div>
            `;
            
            // ç»‘å®šäº‹ä»¶
            card.querySelector('[data-action="edit"]').addEventListener('click', () => showEditProductModal(product.id));
            card.querySelector('[data-action="copy"]').addEventListener('click', () => copyProduct(product.id));
            card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteProductConfirm(product.id));
            
            return card;
        }
        
        // ç»‘å®šäº‹ä»¶
        function bindEvents() {
            // æ·»åŠ äº§å“æŒ‰é’®
            document.querySelectorAll('.add-product-btn').forEach(btn => {
                btn.addEventListener('click', showAddProductModal);
            });
            
            // æœç´¢åŠŸèƒ½
            const searchBtn = document.querySelector('#product-management .search-row .btn-primary');
            const searchInput = document.querySelector('#product-management .search-input');
            
            searchBtn.addEventListener('click', () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchProductsByKeyword(keyword);
                } else {
                    loadProducts();
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // æ’åºåŠŸèƒ½
            const sortBtn = document.querySelector('#product-management .advanced-actions .btn:not(.btn-danger):not(.btn-primary)');
            sortBtn.addEventListener('click', () => {
                const option = prompt('è¯·é€‰æ‹©æ’åºæ–¹å¼:\n1. ä»·æ ¼é™åº\n2. ä»·æ ¼å‡åº\n3. åˆ©æ¶¦ç‡é™åº\n4. åˆ©æ¶¦ç‡å‡åº');
                sortProducts(option);
            });
            
            // å¯¼å‡ºåŠŸèƒ½
            const exportBtn = document.querySelectorAll('#product-management .advanced-actions .btn-primary')[0];
            exportBtn.addEventListener('click', exportProductData);
            
            // å¯¼å…¥åŠŸèƒ½
            const importBtn = document.querySelectorAll('#product-management .advanced-actions .btn-primary')[1];
            importBtn.addEventListener('click', importProductData);
            
            // æ‰¹é‡åˆ é™¤
            const batchDeleteBtn = document.querySelector('#product-management .advanced-actions .btn-danger');
            batchDeleteBtn.addEventListener('click', showBatchDeleteModal);
            
            // å…³é—­æ¨¡æ€æ¡†
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('show');
                    });
                });
            });
        }
        
        // æœç´¢äº§å“
        function searchProductsByKeyword(keyword) {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><p>æœç´¢ä¸­...</p></div>';
            
            searchProducts(keyword).then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â“</div><p>æœªæ‰¾åˆ°ç›¸å…³äº§å“</p></div>';
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('æœç´¢å¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // æ’åºäº§å“
        function sortProducts(option) {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>æ’åºä¸­...</p></div>';
            
            getAllProducts().then(products => {
                let sortedProducts = [...products];
                
                switch (option) {
                    case '1': // ä»·æ ¼é™åº
                        sortedProducts.sort((a, b) => parseFloat(b.declarePrice || 0) - parseFloat(a.declarePrice || 0));
                        break;
                    case '2': // ä»·æ ¼å‡åº
                        sortedProducts.sort((a, b) => parseFloat(a.declarePrice || 0) - parseFloat(b.declarePrice || 0));
                        break;
                    case '3': // åˆ©æ¶¦ç‡é™åº
                        sortedProducts.sort((a, b) => {
                            const profitRateA = (parseFloat(a.declarePrice || 0) - parseFloat(a.costPrice || 0)) / (parseFloat(a.declarePrice || 0) || 1);
                            const profitRateB = (parseFloat(b.declarePrice || 0) - parseFloat(b.costPrice || 0)) / (parseFloat(b.declarePrice || 0) || 1);
                            return profitRateB - profitRateA;
                        });
                        break;
                    case '4': // åˆ©æ¶¦ç‡å‡åº
                        sortedProducts.sort((a, b) => {
                            const profitRateA = (parseFloat(a.declarePrice || 0) - parseFloat(a.costPrice || 0)) / (parseFloat(a.declarePrice || 0) || 1);
                            const profitRateB = (parseFloat(b.declarePrice || 0) - parseFloat(b.costPrice || 0)) / (parseFloat(b.declarePrice || 0) || 1);
                            return profitRateA - profitRateB;
                        });
                        break;
                }
                
                productsGrid.innerHTML = '';
                sortedProducts.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('æ’åºå¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>æ’åºå¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // æ˜¾ç¤ºæ·»åŠ äº§å“æ¨¡æ€æ¡†
        function showAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            modal.classList.add('show');
            
            // æ¸…ç©ºè¡¨å•
            document.getElementById('add-product-name').value = '';
            document.getElementById('add-product-spu').value = '';
            document.getElementById('add-product-skc').value = '';
            document.getElementById('add-product-sku').value = '';
            document.getElementById('add-product-category').value = '';
            document.getElementById('add-product-cost-price').value = '';
            document.getElementById('add-product-declare-price').value = '';
            document.getElementById('add-product-ad-bid-ratio').value = '';
            document.getElementById('add-product-description').value = '';
            document.getElementById('add-product-image-preview').innerHTML = '';
            
            // ç»‘å®šå›¾ç‰‡ä¸Šä¼ 
            const imageUpload = document.getElementById('add-product-image-upload');
            const imageInput = document.getElementById('add-product-image-input');
            const imagePreview = document.getElementById('add-product-image-preview');
            
            imageUpload.onclick = () => imageInput.click();
            
            imageInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            // ç²˜è´´å›¾ç‰‡æ”¯æŒ
            imageUpload.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            };
            
            // ä¿å­˜æŒ‰é’®
            document.getElementById('save-product-btn').onclick = saveNewProduct;
        }
        
        // ä¿å­˜æ–°äº§å“
        function saveNewProduct() {
            const product = {
                name: document.getElementById('add-product-name').value.trim(),
                spu: document.getElementById('add-product-spu').value.trim(),
                skc: document.getElementById('add-product-skc').value.trim(),
                sku: document.getElementById('add-product-sku').value.trim(),
                category: document.getElementById('add-product-category').value,
                costPrice: document.getElementById('add-product-cost-price').value || 0,
                declarePrice: document.getElementById('add-product-declare-price').value || 0,
                adBidRatio: document.getElementById('add-product-ad-bid-ratio').value || 0,
                description: document.getElementById('add-product-description').value.trim(),
                image: '',
                createdAt: new Date().toISOString()
            };
            
            // è·å–å›¾ç‰‡
            const imageElement = document.querySelector('#add-product-image-preview img');
            if (imageElement) {
                product.image = imageElement.src;
            }
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!product.name) {
                alert('è¯·è¾“å…¥äº§å“åç§°');
                return;
            }
            
            saveProduct(product).then(() => {
                alert('äº§å“æ·»åŠ æˆåŠŸï¼');
                document.getElementById('add-product-modal').classList.remove('show');
                loadProducts();
            }).catch(error => {
                console.error('ä¿å­˜å¤±è´¥:', error);
                alert('ä¿å­˜å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // æ˜¾ç¤ºç¼–è¾‘äº§å“æ¨¡æ€æ¡†
        function showEditProductModal(id) {
            getProductById(id).then(product => {
                if (!product) {
                    alert('äº§å“ä¸å­˜åœ¨');
                    return;
                }
                
                const modal = document.getElementById('edit-product-modal');
                modal.classList.add('show');
                
                // å¡«å……è¡¨å•
                document.getElementById('edit-product-name').value = product.name || '';
                document.getElementById('edit-product-spu').value = product.spu || '';
                document.getElementById('edit-product-skc').value = product.skc || '';
                document.getElementById('edit-product-sku').value = product.sku || '';
                document.getElementById('edit-product-category').value = product.category || '';
                document.getElementById('edit-product-cost-price').value = product.costPrice || '';
                document.getElementById('edit-product-declare-price').value = product.declarePrice || '';
                document.getElementById('edit-product-ad-bid-ratio').value = product.adBidRatio || '';
                document.getElementById('edit-product-description').value = product.description || '';
                
                // æ˜¾ç¤ºå›¾ç‰‡é¢„è§ˆ
                const imagePreview = document.getElementById('edit-product-image-preview');
                if (product.image) {
                    imagePreview.innerHTML = `<img src="${product.image}" class="preview-image">`;
                } else {
                    imagePreview.innerHTML = '';
                }
                
                // ç»‘å®šå›¾ç‰‡ä¸Šä¼ 
                const imageUpload = document.getElementById('edit-product-image-upload');
                const imageInput = document.getElementById('edit-product-image-input');
                
                imageUpload.onclick = () => imageInput.click();
                
                imageInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                // ç²˜è´´å›¾ç‰‡æ”¯æŒ
                imageUpload.onpaste = (e) => {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file') {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                };
                
                // æ›´æ–°æŒ‰é’®
                document.getElementById('update-product-btn').onclick = () => updateProduct(id);
            }).catch(error => {
                console.error('è·å–äº§å“å¤±è´¥:', error);
                alert('è·å–äº§å“å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // æ›´æ–°äº§å“
        function updateProduct(id) {
            const updatedProduct = {
                id,
                name: document.getElementById('edit-product-name').value.trim(),
                spu: document.getElementById('edit-product-spu').value.trim(),
                skc: document.getElementById('edit-product-skc').value.trim(),
                sku: document.getElementById('edit-product-sku').value.trim(),
                category: document.getElementById('edit-product-category').value,
                costPrice: document.getElementById('edit-product-cost-price').value || 0,
                declarePrice: document.getElementById('edit-product-declare-price').value || 0,
                adBidRatio: document.getElementById('edit-product-ad-bid-ratio').value || 0,
                description: document.getElementById('edit-product-description').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            // è·å–å›¾ç‰‡
            const imageElement = document.querySelector('#edit-product-image-preview img');
            if (imageElement) {
                updatedProduct.image = imageElement.src;
            }
            
            // éªŒè¯å¿…å¡«é¡¹
            if (!updatedProduct.name) {
                alert('è¯·è¾“å…¥äº§å“åç§°');
                return;
            }
            
            saveProduct(updatedProduct).then(() => {
                alert('äº§å“æ›´æ–°æˆåŠŸï¼');
                document.getElementById('edit-product-modal').classList.remove('show');
                loadProducts();
            }).catch(error => {
                console.error('æ›´æ–°å¤±è´¥:', error);
                alert('æ›´æ–°å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // å¤åˆ¶äº§å“
        function copyProduct(id) {
            getProductById(id).then(product => {
                if (!product) {
                    alert('äº§å“ä¸å­˜åœ¨');
                    return;
                }
                
                // åˆ›å»ºæ–°äº§å“ï¼Œä¸åŒ…å«idå’Œæ—¶é—´æˆ³
                const newProduct = {
                    name: `${product.name} (å‰¯æœ¬)`,
                    spu: product.spu,
                    skc: product.skc,
                    sku: '', // æ¸…ç©ºSKUï¼Œé¿å…é‡å¤
                    category: product.category,
                    costPrice: product.costPrice,
                    declarePrice: product.declarePrice,
                    adBidRatio: product.adBidRatio,
                    description: product.description,
                    image: product.image,
                    createdAt: new Date().toISOString()
                };
                
                saveProduct(newProduct).then(() => {
                    alert('äº§å“å¤åˆ¶æˆåŠŸï¼');
                    loadProducts();
                }).catch(error => {
                    console.error('å¤åˆ¶å¤±è´¥:', error);
                    alert('å¤åˆ¶å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }).catch(error => {
                console.error('è·å–äº§å“å¤±è´¥:', error);
                alert('è·å–äº§å“å¤±è´¥ï¼Œè¯·é‡è¯•');
            });
        }
        
        // åˆ é™¤äº§å“ç¡®è®¤
        function deleteProductConfirm(id) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªäº§å“å—ï¼Ÿ')) {
                deleteProduct(id).then(() => {
                    alert('äº§å“åˆ é™¤æˆåŠŸï¼');
                    loadProducts();
                }).catch(error => {
                    console.error('åˆ é™¤å¤±è´¥:', error);
                    alert('åˆ é™¤å¤±è´¥ï¼Œè¯·é‡è¯•');
                });
            }
        }
        
        // æ˜¾ç¤ºæ‰¹é‡åˆ é™¤æ¨¡æ€æ¡†
        function showBatchDeleteModal() {
            if (confirm('ç¡®å®šè¦åˆ é™¤æ‰€æœ‰é€‰ä¸­çš„äº§å“å—ï¼Ÿ')) {
                // è¿™é‡Œåº”è¯¥è·å–é€‰ä¸­çš„äº§å“IDï¼Œç®€åŒ–å¤„ç†
                alert('æ‰¹é‡åˆ é™¤åŠŸèƒ½éœ€è¦å…ˆé€‰æ‹©äº§å“');
            }
        }
        
        // å¯¼å‡ºäº§å“æ•°æ®
        function exportProductData() {
            alert('å¯¼å‡ºåŠŸèƒ½éœ€è¦å¼•å…¥ExcelJSæˆ–SheetJSåº“');
        }
        
        // å¯¼å…¥äº§å“æ•°æ®
        function importProductData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls,.json';
            fileInput.onchange = (e) => {
                alert('å¯¼å…¥åŠŸèƒ½éœ€è¦å¼•å…¥ExcelJSæˆ–SheetJSåº“');
            };
            fileInput.click();
        }
        
        // æ´»åŠ¨æ¨å¹¿è®¡ç®—é¡µé¢åˆå§‹åŒ–
        function initPromotionCalculation() {
            console.log('åˆå§‹åŒ–æ´»åŠ¨æ¨å¹¿è®¡ç®—é¡µé¢');
            loadPromotionProducts();
            bindPromotionEvents();
        }
        
        // åŠ è½½æ´»åŠ¨æ¨å¹¿äº§å“
        function loadPromotionProducts() {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â³</div><p>åŠ è½½ä¸­...</p></div>';
            
            getAllProducts().then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">ğŸ“Š</div>
                            <p>æš‚æ— äº§å“æ•°æ®</p>
                            <button class="btn btn-primary add-product-btn">æ·»åŠ ç¬¬ä¸€ä¸ªäº§å“</button>
                        </div>
                    `;
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createPromotionProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('åŠ è½½äº§å“å¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // åˆ›å»ºæ´»åŠ¨æ¨å¹¿äº§å“å¡ç‰‡
        function createPromotionProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.id = product.id;
            
            // è®¡ç®—æŒ‡æ ‡
            const metrics = calculatePromotionMetrics(product);
            
            card.innerHTML = `
                <img src="${product.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${product.name || 'äº§å“å›¾ç‰‡'}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name || 'æœªå‘½åäº§å“'}</div>
                    <div class="product-details">
                        <div><span>SKU:</span> <span>${product.sku || '-'}</span></div>
                        <div><span>è¿›è´§ä»·æ ¼:</span> <span class="cost-price">Â¥${product.costPrice || '0.00'}</span></div>
                        <div><span>ç”³æŠ¥ä»·æ ¼:</span> <span class="declare-price">Â¥${product.declarePrice || '0.00'}</span></div>
                        <div><span>å¹¿å‘Šå‡ºä»·æ¯”ä¾‹:</span> <span>${product.adBidRatio || '0'}</span></div>
                    </div>
                    
                    <div class="activity-price-section">
                        <div><span>95æŠ˜å–ä»·:</span> <span>Â¥${metrics.sellPrice}</span></div>
                        <div><span>95æŠ˜åˆ©æ¶¦:</span> <span>Â¥${metrics.profit}</span></div>
                        <div><span>åˆ©æ¶¦ç‡:</span> <span>${metrics.profitRate}%</span></div>
                    </div>
                    
                    <div class="promotion-section">
                        <div><span>å¹¿å‘Šæ‰£è´¹:</span> <span>Â¥${metrics.adFee}</span></div>
                        <div><span>æ¨å¹¿ååˆ©æ¶¦:</span> <span>Â¥${metrics.promotionProfit}</span></div>
                    </div>
                </div>
                <div class="product-actions">
                    <button class="action-btn edit-btn" data-action="edit">ç¼–è¾‘</button>
                    <button class="action-btn delete-btn" data-action="delete">åˆ é™¤</button>
                </div>
            `;
            
            // ç»‘å®šäº‹ä»¶
            card.querySelector('[data-action="edit"]').addEventListener('click', () => showEditProductModal(product.id));
            card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteProductConfirm(product.id));
            
            return card;
        }
        
        // è®¡ç®—æ´»åŠ¨æ¨å¹¿æŒ‡æ ‡
        function calculatePromotionMetrics(product) {
            const declarePrice = parseFloat(product.declarePrice) || 0;
            const costPrice = parseFloat(product.costPrice) || 0;
            const adBidRatio = parseFloat(product.adBidRatio) || 1;
            
            // 95æŠ˜å–ä»·
            const sellPrice = (declarePrice * 0.95).toFixed(2);
            
            // 95æŠ˜åˆ©æ¶¦
            const profit = (sellPrice - costPrice).toFixed(2);
            
            // åˆ©æ¶¦ç‡
            const profitRate = sellPrice > 0 ? ((profit / sellPrice) * 100).toFixed(1) : '0.0';
            
            // å¹¿å‘Šæ‰£è´¹
            const adFee = adBidRatio > 0 ? (declarePrice / adBidRatio).toFixed(2) : '0.00';
            
            // æ¨å¹¿ååˆ©æ¶¦
            const promotionProfit = (declarePrice - parseFloat(adFee) - costPrice).toFixed(2);
            
            return {
                sellPrice,
                profit,
                profitRate,
                adFee,
                promotionProfit
            };
        }
        
        // ç»‘å®šæ´»åŠ¨æ¨å¹¿é¡µé¢äº‹ä»¶
        function bindPromotionEvents() {
            // æ·»åŠ äº§å“æŒ‰é’®
            document.querySelector('#promotion-calculation .add-product-btn').addEventListener('click', showAddProductModal);
            
            // å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-promotion-btn').addEventListener('click', exportPromotionProducts);
            
            // å¯¼å…¥æŒ‰é’®
            document.getElementById('import-promotion-btn').addEventListener('click', importProductData);
            
            // æœç´¢åŠŸèƒ½
            const searchBtn = document.querySelector('#promotion-calculation .search-row .btn-primary');
            const searchInput = document.querySelector('#promotion-calculation .search-input[placeholder="æœç´¢äº§å“åç§°ã€å…³é”®è¯..."]');
            
            searchBtn.addEventListener('click', () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchProductsByKeywordPromotion(keyword);
                } else {
                    loadPromotionProducts();
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // æ’åºåŠŸèƒ½
            const sortBtn = document.querySelector('#promotion-calculation .advanced-actions .btn:not(.btn-danger)');
            sortBtn.addEventListener('click', () => {
                const option = prompt('è¯·é€‰æ‹©æ’åºæ–¹å¼:\n1. åˆ©æ¶¦é™åº\n2. åˆ©æ¶¦å‡åº\n3. æ¨å¹¿ååˆ©æ¶¦é™åº\n4. æ¨å¹¿ååˆ©æ¶¦å‡åº');
                
                switch (option) {
                    case '1':
                        sortPromotionProducts('profit', false);
                        break;
                    case '2':
                        sortPromotionProducts('profit', true);
                        break;
                    case '3':
                        sortPromotionProducts('promotionProfit', false);
                        break;
                    case '4':
                        sortPromotionProducts('promotionProfit', true);
                        break;
                }
            });
            
            // æ‰¹é‡åˆ é™¤
            const batchDeleteBtn = document.querySelector('#promotion-calculation .btn-danger');
            batchDeleteBtn.addEventListener('click', showBatchDeleteModal);
        }
        
        // æ’åºæ´»åŠ¨æ¨å¹¿äº§å“
        function sortPromotionProducts(sortBy, ascending) {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>æ’åºä¸­...</p></div>';
            
            getAllProducts().then(products => {
                // è®¡ç®—æ¯ä¸ªäº§å“çš„æŒ‡æ ‡
                const productsWithMetrics = products.map(product => ({
                    product,
                    metrics: calculatePromotionMetrics(product)
                }));
                
                // æ’åº
                productsWithMetrics.sort((a, b) => {
                    let aValue = parseFloat(a.metrics[sortBy]);
                    let bValue = parseFloat(b.metrics[sortBy]);
                    
                    if (ascending) {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                });
                
                // æ˜¾ç¤ºæ’åºåçš„äº§å“
                productsGrid.innerHTML = '';
                productsWithMetrics.forEach(item => {
                    const productCard = createPromotionProductCard(item.product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('æ’åºå¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>æ’åºå¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // æœç´¢æ´»åŠ¨æ¨å¹¿äº§å“
        function searchProductsByKeywordPromotion(keyword) {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ”</div><p>æœç´¢ä¸­...</p></div>';
            
            searchProducts(keyword).then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">â“</div><p>æœªæ‰¾åˆ°ç›¸å…³äº§å“</p></div>';
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createPromotionProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('æœç´¢å¤±è´¥:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">âŒ</div><p>æœç´¢å¤±è´¥ï¼Œè¯·é‡è¯•</p></div>';
            });
        }
        
        // å¯¼å‡ºæ´»åŠ¨æ¨å¹¿äº§å“
        function exportPromotionProducts() {
            alert('å¯¼å‡ºåŠŸèƒ½éœ€è¦å¼•å…¥SheetJSåº“');
        }
        
        // åˆ©æ¶¦è®¡ç®—é¡µé¢åˆå§‹åŒ–
        function initProfitCalculation() {
            console.log('åˆå§‹åŒ–åˆ©æ¶¦è®¡ç®—é¡µé¢');
            bindProfitEvents();
        }
        
        // ç»‘å®šåˆ©æ¶¦è®¡ç®—é¡µé¢äº‹ä»¶
        function bindProfitEvents() {
            // å¯¼å…¥ExcelæŒ‰é’®
            document.getElementById('import-profit-btn').addEventListener('click', importProfitExcel);
            
            // å¯¼å‡ºç»“æœæŒ‰é’® (åˆå§‹çŠ¶æ€ç¦ç”¨)
            const exportResultBtn = document.getElementById('export-result-btn');
            exportResultBtn.disabled = true;
            exportResultBtn.addEventListener('click', exportCalculationResult);
            
            // æ¸…ç©ºç»“æœæŒ‰é’®
            document.getElementById('clear-result-btn').addEventListener('click', clearCalculationResult);
            
            // æ‹–æ‹½ä¸Šä¼ 
            const dropzone = document.getElementById('excel-dropzone');
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e6f7ff';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleExcelFile(e.dataTransfer.files[0]);
                }
            });
            
            dropzone.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls';
                fileInput.onchange = (e) => {
                    if (e.target.files.length) {
                        handleExcelFile(e.target.files[0]);
                    }
                };
                fileInput.click();
            });
        }
        
        // å¤„ç†Excelæ–‡ä»¶
        function handleExcelFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('è¯·é€‰æ‹©Excelæ–‡ä»¶ (.xlsx æˆ– .xls)');
                return;
            }
            
            // æ¨¡æ‹Ÿå¯¼å…¥å¤„ç†
            alert('Excelå¯¼å…¥åŠŸèƒ½éœ€è¦å¼•å…¥SheetJSåº“');
        }
        
        // å¯¼å…¥Excelè¿›è¡Œåˆ©æ¶¦è®¡ç®—
        function importProfitExcel() {
            alert('Excelå¯¼å…¥åŠŸèƒ½éœ€è¦å¼•å…¥SheetJSåº“');
        }
        
        // å¯¼å‡ºè®¡ç®—ç»“æœ
        function exportCalculationResult() {
            alert('å¯¼å‡ºåŠŸèƒ½éœ€è¦å¼•å…¥SheetJSåº“');
        }
        
        // æ¸…ç©ºè®¡ç®—ç»“æœ
        function clearCalculationResult() {
            const resultContainer = document.getElementById('calculation-result');
            resultContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">ğŸ“Š</div><p>è¯·å¯¼å…¥Excelæ–‡ä»¶è¿›è¡Œåˆ©æ¶¦è®¡ç®—</p></div>';
            
            // ç¦ç”¨å¯¼å‡ºæŒ‰é’®
            document.getElementById('export-result-btn').disabled = true;
        }
        
        // åˆå§‹åŒ–åº”ç”¨
        function init() {
            initTabs();
            initProductManagement();
        }
        
        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>