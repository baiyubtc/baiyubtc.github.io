<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>产品管理系统</title>
    <style>
        /* 全局样式 */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* 头部样式 */
        .header {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            color: #1890ff;
            font-size: 24px;
            margin-bottom: 10px;
        }
        
        /* 标签页样式 */
        .nav-tabs {
            display: flex;
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
            overflow-x: auto;
        }
        
        .tab {
            padding: 15px 25px;
            cursor: pointer;
            flex-shrink: 0;
            transition: all 0.3s;
            font-weight: 500;
            position: relative;
        }
        
        .tab.active {
            color: #1890ff;
            background-color: #f0f7ff;
        }
        
        .tab.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background-color: #1890ff;
        }
        
        /* 标签内容样式 */
        .tab-content {
            background-color: #fff;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            padding: 20px;
            min-height: 400px;
        }
        
        .tab-pane {
            display: none;
        }
        
        .tab-pane.active {
            display: block;
        }
        
        /* 产品卡片样式 */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .product-card {
            border: 1px solid #e8e8e8;
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s;
            position: relative;
            height: 400px;
            display: flex;
            flex-direction: column;
        }
        
        .product-card:hover {
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .product-image {
            width: 100%;
            height: 180px;
            object-fit: cover;
            background-color: #f5f5f5;
        }
        
        .product-info {
            padding: 15px;
            flex: 1;
            overflow-y: auto;
        }
        
        .product-name {
            font-size: 16px;
            font-weight: 500;
            margin-bottom: 8px;
            color: #333;
        }
        
        .product-details {
            font-size: 14px;
            color: #666;
            margin-bottom: 10px;
        }
        
        .product-details div {
            margin-bottom: 4px;
            display: flex;
            justify-content: space-between;
        }
        
        .product-actions {
            display: flex;
            justify-content: space-between;
            padding: 10px 15px;
            background-color: #fafafa;
            border-top: 1px solid #e8e8e8;
        }
        
        .action-btn {
            padding: 5px 15px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .edit-btn {
            background-color: #1890ff;
            color: white;
        }
        
        .edit-btn:hover {
            background-color: #40a9ff;
        }
        
        .delete-btn {
            background-color: #ff4d4f;
            color: white;
        }
        
        .delete-btn:hover {
            background-color: #ff7875;
        }
        
        /* 功能按钮样式 */
        .function-buttons {
            display: flex;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .btn {
            padding: 8px 16px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background-color: #1890ff;
            color: white;
        }
        
        .btn-primary:hover {
            background-color: #40a9ff;
        }
        
        .btn-danger {
            background-color: #ff4d4f;
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #ff7875;
        }
        
        /* 搜索样式 */
        .search-row {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            align-items: center;
        }
        
        .search-input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .search-input:focus {
            outline: none;
            border-color: #1890ff;
        }
        
        /* 模态框样式 */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.show {
            display: flex;
        }
        
        .modal-content {
            background-color: white;
            border-radius: 8px;
            padding: 20px;
            width: 90%;
            max-width: 500px;
            max-height: 80vh;
            overflow-y: auto;
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 18px;
            font-weight: 500;
        }
        
        .close-btn {
            background: none;
            border: none;
            font-size: 20px;
            cursor: pointer;
            color: #999;
        }
        
        .close-btn:hover {
            color: #333;
        }
        
        /* 表单样式 */
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-size: 14px;
            color: #333;
        }
        
        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #1890ff;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            margin-top: 20px;
        }
        
        /* 空状态样式 */
        .empty-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 60px 20px;
            text-align: center;
            color: #999;
        }
        
        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        /* 分页样式 */
        .pagination {
            display: flex;
            justify-content: center;
            margin-top: 20px;
            gap: 5px;
        }
        
        .page-item {
            padding: 5px 10px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .page-item:hover {
            border-color: #1890ff;
            color: #1890ff;
        }
        
        .page-item.active {
            background-color: #1890ff;
            color: white;
            border-color: #1890ff;
        }
        
        .page-item.disabled {
            cursor: not-allowed;
            opacity: 0.5;
        }
        
        /* 图片上传样式 */
        .image-upload-container {
            border: 2px dashed #d9d9d9;
            border-radius: 4px;
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin-bottom: 15px;
        }
        
        .image-upload-container:hover {
            border-color: #1890ff;
        }
        
        .preview-image {
            max-width: 100%;
            max-height: 200px;
            display: block;
            margin: 0 auto;
        }
        
        /* 隐藏文件输入 */
        .image-upload-container input[type="file"] {
            display: none;
        }
        
        /* 价格信息样式 */
        .cost-price {
            color: #ff4d4f;
            font-weight: 500;
        }
        
        .declare-price {
            color: #52c41a;
            font-weight: 500;
        }
        
        /* 利润状态样式 */
        .profit-high {
            background-color: #f6ffed;
            color: #52c41a;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .profit-medium {
            background-color: #fffbe6;
            color: #faad14;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        .profit-low {
            background-color: #fff2f0;
            color: #ff4d4f;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 12px;
        }
        
        /* 活动价格区域 */
        .activity-price-section {
            background-color: #fff7e6;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        /* 促销部分 */
        .promotion-section {
            background-color: #f6ffed;
            padding: 10px;
            border-radius: 4px;
            margin-top: 10px;
        }
        
        /* 编辑输入框 */
        .edit-input {
            width: 80px;
            padding: 2px 6px;
            border: 1px solid #d9d9d9;
            border-radius: 4px;
            font-size: 14px;
        }
        
        /* 利润计算容器 */
        .profit-calculation-container {
            max-width: 100%;
            overflow-x: auto;
        }
        
        /* 文件上传容器 */
        .file-upload-container {
            border: 2px dashed #d9d9d9;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            margin: 20px 0;
        }
        
        .file-upload-container:hover {
            border-color: #1890ff;
            background-color: #f0f7ff;
        }
        
        /* 高级操作 */
        .advanced-actions {
            display: flex;
            gap: 10px;
        }
        
        /* 响应式设计 */
        @media (max-width: 768px) {
            .products-grid {
                grid-template-columns: 1fr;
            }
            
            .function-buttons {
                flex-direction: column;
                gap: 10px;
            }
            
            .search-row {
                flex-direction: column;
            }
            
            .search-input {
                width: 100%;
            }
            
            .nav-tabs {
                flex-wrap: nowrap;
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }
        }
        
        /* 结果表格样式 */
        .result-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 20px;
        }
        
        .result-table th,
        .result-table td {
            padding: 10px;
            text-align: left;
            border-bottom: 1px solid #e8e8e8;
        }
        
        .result-table th {
            background-color: #fafafa;
            font-weight: 500;
        }
        
        .summary-row {
            background-color: #f0f7ff;
            font-weight: 500;
        }
        
        .positive-profit {
            color: #52c41a;
        }
        
        .negative-profit {
            color: #ff4d4f;
        }
        
        /* 汇总统计 */
        .summary-stats {
            display: flex;
            justify-content: space-around;
            margin-top: 20px;
            padding: 15px;
            background-color: #fafafa;
            border-radius: 4px;
        }
        
        .summary-item {
            text-align: center;
        }
        
        .summary-label {
            display: block;
            font-size: 14px;
            color: #666;
            margin-bottom: 5px;
        }
        
        .summary-value {
            display: block;
            font-size: 18px;
            font-weight: 500;
            color: #333;
        }
        
        .profit-positive {
            color: #52c41a;
        }
        
        .profit-negative {
            color: #ff4d4f;
        }
        
        .data-notice {
            text-align: center;
            color: #999;
            font-size: 14px;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>产品管理系统</h1>
            <p>全面的产品管理、活动推广计算和利润核算工具</p>
        </div>
        
        <div class="nav-tabs">
            <div class="tab active" data-target="product-management">产品管理</div>
            <div class="tab" data-target="promotion-calculation">活动推广计算</div>
            <div class="tab" data-target="profit-calculation">利润核算</div>
        </div>
        
        <div class="tab-content">
            <!-- 产品管理标签页 -->
            <div id="product-management" class="tab-pane active">
                <div class="function-buttons">
                    <div>
                        <button class="btn btn-primary add-product-btn">添加产品</button>
                    </div>
                    <div class="advanced-actions">
                        <button class="btn">排序</button>
                        <button class="btn btn-primary">导出</button>
                        <button class="btn btn-primary">导入</button>
                        <button class="btn btn-danger">批量删除</button>
                    </div>
                </div>
                
                <div class="search-row">
                    <input type="text" class="search-input" placeholder="搜索产品名称、关键词...">
                    <button class="btn btn-primary">搜索</button>
                </div>
                
                <div class="products-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">📦</div>
                        <p>暂无产品数据</p>
                        <button class="btn btn-primary add-product-btn">添加第一个产品</button>
                    </div>
                </div>
                
                <div class="pagination" style="display: none;">
                    <div class="page-item prev disabled">上一页</div>
                    <div class="page-item active">1</div>
                    <div class="page-item next">下一页</div>
                </div>
            </div>
            
            <!-- 活动推广计算标签页 -->
            <div id="promotion-calculation" class="tab-pane">
                <div class="function-buttons">
                    <div>
                        <button class="btn btn-primary add-product-btn">添加产品</button>
                    </div>
                    <div class="advanced-actions">
                        <button class="btn">排序</button>
                        <button id="export-promotion-btn" class="btn btn-primary">导出</button>
                        <button id="import-promotion-btn" class="btn btn-primary">导入</button>
                        <button class="btn btn-danger">批量删除</button>
                    </div>
                </div>
                
                <div class="search-row">
                    <input type="text" class="search-input" placeholder="搜索产品名称、关键词...">
                    <button class="btn btn-primary">搜索</button>
                    <input type="text" class="img-search-input" placeholder="图片搜索" disabled>
                    <button class="btn btn-primary">图片搜索</button>
                </div>
                
                <div class="products-grid">
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>暂无产品数据</p>
                        <button class="btn btn-primary add-product-btn">添加第一个产品</button>
                    </div>
                </div>
            </div>
            
            <!-- 利润核算标签页 -->
            <div id="profit-calculation" class="tab-pane">
                <div class="function-buttons">
                    <div>
                        <button id="import-profit-btn" class="btn btn-primary">导入Excel</button>
                    </div>
                    <div class="advanced-actions">
                        <button id="export-result-btn" class="btn btn-primary">导出结果</button>
                        <button id="clear-result-btn" class="btn btn-danger">清空结果</button>
                    </div>
                </div>
                
                <div class="file-upload-container" id="excel-dropzone">
                    <div class="empty-state-icon">📁</div>
                    <p>点击或拖拽Excel文件到此处进行导入</p>
                    <p style="font-size: 12px; color: #999; margin-top: 10px;">支持.xlsx和.xls格式，文件需包含SKU和收入金额列</p>
                </div>
                
                <div id="calculation-result" class="profit-calculation-container">
                    <div class="empty-state">
                        <div class="empty-state-icon">📊</div>
                        <p>请导入Excel文件进行利润计算</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- 添加产品模态框 -->
    <div id="add-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">添加产品</h2>
                <button class="close-btn">×</button>
            </div>
            
            <div class="image-upload-container" id="add-product-image-upload">
                <input type="file" id="add-product-image-input" accept="image/*">
                <div id="add-product-image-preview"></div>
                <p>点击上传产品图片</p>
            </div>
            
            <div class="form-group">
                <label for="add-product-name">产品名称</label>
                <input type="text" id="add-product-name" placeholder="请输入产品名称">
            </div>
            
            <div class="form-group">
                <label for="add-product-spu">SPU</label>
                <input type="text" id="add-product-spu" placeholder="请输入SPU">
            </div>
            
            <div class="form-group">
                <label for="add-product-skc">SKC</label>
                <input type="text" id="add-product-skc" placeholder="请输入SKC">
            </div>
            
            <div class="form-group">
                <label for="add-product-sku">SKU</label>
                <input type="text" id="add-product-sku" placeholder="请输入SKU">
            </div>
            
            <div class="form-group">
                <label for="add-product-category">分类</label>
                <select id="add-product-category">
                    <option value="">请选择分类</option>
                    <option value="服装">服装</option>
                    <option value="电子产品">电子产品</option>
                    <option value="家居">家居</option>
                    <option value="食品">食品</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="add-product-cost-price">进货价格</label>
                <input type="number" id="add-product-cost-price" placeholder="请输入进货价格" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-declare-price">申报价格</label>
                <input type="number" id="add-product-declare-price" placeholder="请输入申报价格" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-ad-bid-ratio">广告出价比例</label>
                <input type="number" id="add-product-ad-bid-ratio" placeholder="请输入广告出价比例" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="add-product-description">描述</label>
                <textarea id="add-product-description" rows="3" placeholder="请输入产品描述"></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn close-btn">取消</button>
                <button class="btn btn-primary" id="save-product-btn">保存</button>
            </div>
        </div>
    </div>
    
    <!-- 编辑产品模态框 -->
    <div id="edit-product-modal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">编辑产品</h2>
                <button class="close-btn">×</button>
            </div>
            
            <div class="image-upload-container" id="edit-product-image-upload">
                <input type="file" id="edit-product-image-input" accept="image/*">
                <div id="edit-product-image-preview"></div>
                <p>点击上传产品图片</p>
            </div>
            
            <div class="form-group">
                <label for="edit-product-name">产品名称</label>
                <input type="text" id="edit-product-name" placeholder="请输入产品名称">
            </div>
            
            <div class="form-group">
                <label for="edit-product-spu">SPU</label>
                <input type="text" id="edit-product-spu" placeholder="请输入SPU">
            </div>
            
            <div class="form-group">
                <label for="edit-product-skc">SKC</label>
                <input type="text" id="edit-product-skc" placeholder="请输入SKC">
            </div>
            
            <div class="form-group">
                <label for="edit-product-sku">SKU</label>
                <input type="text" id="edit-product-sku" placeholder="请输入SKU">
            </div>
            
            <div class="form-group">
                <label for="edit-product-category">分类</label>
                <select id="edit-product-category">
                    <option value="">请选择分类</option>
                    <option value="服装">服装</option>
                    <option value="电子产品">电子产品</option>
                    <option value="家居">家居</option>
                    <option value="食品">食品</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="edit-product-cost-price">进货价格</label>
                <input type="number" id="edit-product-cost-price" placeholder="请输入进货价格" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-declare-price">申报价格</label>
                <input type="number" id="edit-product-declare-price" placeholder="请输入申报价格" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-ad-bid-ratio">广告出价比例</label>
                <input type="number" id="edit-product-ad-bid-ratio" placeholder="请输入广告出价比例" step="0.01" min="0">
            </div>
            
            <div class="form-group">
                <label for="edit-product-description">描述</label>
                <textarea id="edit-product-description" rows="3" placeholder="请输入产品描述"></textarea>
            </div>
            
            <div class="modal-footer">
                <button class="btn close-btn">取消</button>
                <button class="btn btn-primary" id="update-product-btn">更新</button>
            </div>
        </div>
    </div>
    
    <script>
        // 数据库配置
        const DB_NAME = 'ProductManagementDB';
        const DB_VERSION = 5;
        const STORES = {
            PRODUCTS: 'products',
            CATEGORIES: 'categories'
        };
        
        // 打开数据库连接
        function openDatabase() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => {
                    console.error('打开数据库失败:', request.error);
                    reject(request.error);
                };
                
                request.onsuccess = () => {
                    console.log('数据库打开成功');
                    resolve(request.result);
                };
                
                request.onupgradeneeded = (event) => {
                    console.log('数据库版本升级:', event.oldVersion, '->', event.newVersion);
                    const db = event.target.result;
                    const transaction = event.target.transaction;
                    
                    // 获取旧版本号
                    const oldVersion = event.oldVersion;
                    
                    // 如果是新版本，创建结构
                    if (oldVersion < 1) {
                        // 创建产品存储
                        if (!db.objectStoreNames.contains(STORES.PRODUCTS)) {
                            const productStore = db.createObjectStore(STORES.PRODUCTS, { keyPath: 'id', autoIncrement: true });
                            productStore.createIndex('name', 'name', { unique: false });
                            productStore.createIndex('sku', 'sku', { unique: false });
                            productStore.createIndex('category', 'category', { unique: false });
                        }
                        
                        // 创建分类存储
                        if (!db.objectStoreNames.contains(STORES.CATEGORIES)) {
                            const categoryStore = db.createObjectStore(STORES.CATEGORIES, { keyPath: 'id', autoIncrement: true });
                            categoryStore.createIndex('name', 'name', { unique: true });
                        }
                    }
                    
                    // 版本5: 添加新索引
                    if (oldVersion < 5) {
                        const productStore = transaction.objectStore(STORES.PRODUCTS);
                        
                        try {
                            // 检查索引是否已存在，避免重复创建
                            if (!productStore.indexNames.contains('costPrice')) {
                                productStore.createIndex('costPrice', 'costPrice', { unique: false });
                                console.log('已创建costPrice索引');
                            }
                            
                            if (!productStore.indexNames.contains('declarePrice')) {
                                productStore.createIndex('declarePrice', 'declarePrice', { unique: false });
                                console.log('已创建declarePrice索引');
                            }
                            
                            if (!productStore.indexNames.contains('adBidRatio')) {
                                productStore.createIndex('adBidRatio', 'adBidRatio', { unique: false });
                                console.log('已创建adBidRatio索引');
                            }
                        } catch (error) {
                            console.warn('索引创建警告:', error);
                        }
                    }
                };
            });
        }
        
        // 获取所有产品
        function getAllProducts() {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readonly');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.getAll();
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            });
        }
        
        // 保存产品
        function saveProduct(product) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    
                    const request = product.id ? store.put(product) : store.add(product);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => {
                        // 如果是新增产品，将id添加到产品对象中
                        if (!product.id) {
                            product.id = request.result;
                        }
                        resolve(product);
                    };
                });
            });
        }
        
        // 删除产品
        function deleteProduct(id) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.delete(id);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve();
                });
            });
        }
        
        // 批量删除产品
        function deleteProducts(ids) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readwrite');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    
                    // 删除每个产品
                    ids.forEach(id => {
                        store.delete(id);
                    });
                    
                    transaction.oncomplete = () => resolve();
                    transaction.onerror = () => reject(transaction.error);
                });
            });
        }
        
        // 通过ID获取产品
        function getProductById(id) {
            return openDatabase().then(db => {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(STORES.PRODUCTS, 'readonly');
                    const store = transaction.objectStore(STORES.PRODUCTS);
                    const request = store.get(id);
                    
                    request.onerror = () => reject(request.error);
                    request.onsuccess = () => resolve(request.result);
                });
            });
        }
        
        // 搜索产品
        function searchProducts(keyword) {
            return getAllProducts().then(products => {
                return products.filter(product => {
                    const searchText = `${product.name || ''} ${product.sku || ''} ${product.spu || ''} ${product.skc || ''}`.toLowerCase();
                    return searchText.includes(keyword.toLowerCase());
                });
            });
        }
        
        // 导出产品数据
        function exportProducts() {
            return getAllProducts().then(products => {
                const exportData = products.map(product => ({
                    '产品名称': product.name,
                    'SPU': product.spu,
                    'SKC': product.skc,
                    'SKU': product.sku,
                    '分类': product.category,
                    '进货价格': product.costPrice,
                    '申报价格': product.declarePrice,
                    '广告出价比例': product.adBidRatio,
                    '描述': product.description
                }));
                
                return exportData;
            });
        }
        
        // 计算产品指标
        function calculateProductMetrics(product) {
            const declarePrice = parseFloat(product.declarePrice) || 0;
            const costPrice = parseFloat(product.costPrice) || 0;
            const adBidRatio = parseFloat(product.adBidRatio) || 1;
            
            // 广告扣费
            const adFee = adBidRatio > 0 ? (declarePrice / adBidRatio).toFixed(2) : '0.00';
            
            // 推广后利润
            const promotionProfit = (declarePrice - parseFloat(adFee) - costPrice).toFixed(2);
            
            // 95折售价
            const sellPrice95 = (declarePrice * 0.95).toFixed(2);
            
            // 95折利润
            const profit95 = (parseFloat(sellPrice95) - costPrice).toFixed(2);
            
            // 95折利润率
            const profitRate95 = sellPrice95 > 0 ? ((profit95 / sellPrice95) * 100).toFixed(1) : '0.0';
            
            return {
                adFee,
                promotionProfit,
                sellPrice95,
                profit95,
                profitRate95
            };
        }
        
        // 标签页切换功能
        function initTabs() {
            const tabs = document.querySelectorAll('.tab');
            const tabPanes = document.querySelectorAll('.tab-pane');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', () => {
                    const target = tab.getAttribute('data-target');
                    
                    // 移除所有活动状态
                    tabs.forEach(t => t.classList.remove('active'));
                    tabPanes.forEach(pane => pane.classList.remove('active'));
                    
                    // 添加当前活动状态
                    tab.classList.add('active');
                    document.getElementById(target).classList.add('active');
                    
                    // 初始化对应页面
                    if (target === 'product-management') {
                        initProductManagement();
                    } else if (target === 'promotion-calculation') {
                        initPromotionCalculation();
                    } else if (target === 'profit-calculation') {
                        initProfitCalculation();
                    }
                });
            });
        }
        
        // 产品管理页面初始化
        function initProductManagement() {
            console.log('初始化产品管理页面');
            loadProducts();
            bindEvents();
        }
        
        // 加载产品列表
        function loadProducts() {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⏳</div><p>加载中...</p></div>';
            
            getAllProducts().then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📦</div>
                            <p>暂无产品数据</p>
                            <button class="btn btn-primary add-product-btn">添加第一个产品</button>
                        </div>
                    `;
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('加载产品失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>加载失败，请重试</p></div>';
            });
        }
        
        // 创建产品卡片
        function createProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.id = product.id;
            
            // 计算利润状态
            const profit = (parseFloat(product.declarePrice) || 0) - (parseFloat(product.costPrice) || 0);
            const profitRate = (parseFloat(product.declarePrice) || 0) > 0 ? (profit / parseFloat(product.declarePrice)) * 100 : 0;
            let profitStatusClass = 'profit-medium';
            let profitStatusText = '中等';
            
            if (profitRate >= 50) {
                profitStatusClass = 'profit-high';
                profitStatusText = '高';
            } else if (profitRate <= 20) {
                profitStatusClass = 'profit-low';
                profitStatusText = '低';
            }
            
            card.innerHTML = `
                <img src="${product.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${product.name || '产品图片'}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name || '未命名产品'}</div>
                    <div class="product-details">
                        <div><span>SKU:</span> <span>${product.sku || '-'}</span></div>
                        <div><span>SPU:</span> <span>${product.spu || '-'}</span></div>
                        <div><span>SKC:</span> <span>${product.skc || '-'}</span></div>
                        <div><span>分类:</span> <span>${product.category || '未分类'}</span></div>
                        <div><span>进货价格:</span> <span class="cost-price">¥${product.costPrice || '0.00'}</span></div>
                        <div><span>申报价格:</span> <span class="declare-price">¥${product.declarePrice || '0.00'}</span></div>
                        <div><span>广告出价比例:</span> <span>${product.adBidRatio || '0'}</span></div>
                        <div><span>利润状态:</span> <span class="${profitStatusClass}">${profitStatusText}</span></div>
                    </div>
                </div>
                <div class="product-actions">
                    <button class="action-btn edit-btn" data-action="edit">编辑</button>
                    <button class="action-btn" data-action="copy">复制</button>
                    <button class="action-btn delete-btn" data-action="delete">删除</button>
                </div>
            `;
            
            // 绑定事件
            card.querySelector('[data-action="edit"]').addEventListener('click', () => showEditProductModal(product.id));
            card.querySelector('[data-action="copy"]').addEventListener('click', () => copyProduct(product.id));
            card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteProductConfirm(product.id));
            
            return card;
        }
        
        // 绑定事件
        function bindEvents() {
            // 添加产品按钮
            document.querySelectorAll('.add-product-btn').forEach(btn => {
                btn.addEventListener('click', showAddProductModal);
            });
            
            // 搜索功能
            const searchBtn = document.querySelector('#product-management .search-row .btn-primary');
            const searchInput = document.querySelector('#product-management .search-input');
            
            searchBtn.addEventListener('click', () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchProductsByKeyword(keyword);
                } else {
                    loadProducts();
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // 排序功能
            const sortBtn = document.querySelector('#product-management .advanced-actions .btn:not(.btn-danger):not(.btn-primary)');
            sortBtn.addEventListener('click', () => {
                const option = prompt('请选择排序方式:\n1. 价格降序\n2. 价格升序\n3. 利润率降序\n4. 利润率升序');
                sortProducts(option);
            });
            
            // 导出功能
            const exportBtn = document.querySelectorAll('#product-management .advanced-actions .btn-primary')[0];
            exportBtn.addEventListener('click', exportProductData);
            
            // 导入功能
            const importBtn = document.querySelectorAll('#product-management .advanced-actions .btn-primary')[1];
            importBtn.addEventListener('click', importProductData);
            
            // 批量删除
            const batchDeleteBtn = document.querySelector('#product-management .advanced-actions .btn-danger');
            batchDeleteBtn.addEventListener('click', showBatchDeleteModal);
            
            // 关闭模态框
            document.querySelectorAll('.close-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.modal').forEach(modal => {
                        modal.classList.remove('show');
                    });
                });
            });
        }
        
        // 搜索产品
        function searchProductsByKeyword(keyword) {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><p>搜索中...</p></div>';
            
            searchProducts(keyword).then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❓</div><p>未找到相关产品</p></div>';
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('搜索失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>搜索失败，请重试</p></div>';
            });
        }
        
        // 排序产品
        function sortProducts(option) {
            const productsGrid = document.querySelector('#product-management .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📊</div><p>排序中...</p></div>';
            
            getAllProducts().then(products => {
                let sortedProducts = [...products];
                
                switch (option) {
                    case '1': // 价格降序
                        sortedProducts.sort((a, b) => parseFloat(b.declarePrice || 0) - parseFloat(a.declarePrice || 0));
                        break;
                    case '2': // 价格升序
                        sortedProducts.sort((a, b) => parseFloat(a.declarePrice || 0) - parseFloat(b.declarePrice || 0));
                        break;
                    case '3': // 利润率降序
                        sortedProducts.sort((a, b) => {
                            const profitRateA = (parseFloat(a.declarePrice || 0) - parseFloat(a.costPrice || 0)) / (parseFloat(a.declarePrice || 0) || 1);
                            const profitRateB = (parseFloat(b.declarePrice || 0) - parseFloat(b.costPrice || 0)) / (parseFloat(b.declarePrice || 0) || 1);
                            return profitRateB - profitRateA;
                        });
                        break;
                    case '4': // 利润率升序
                        sortedProducts.sort((a, b) => {
                            const profitRateA = (parseFloat(a.declarePrice || 0) - parseFloat(a.costPrice || 0)) / (parseFloat(a.declarePrice || 0) || 1);
                            const profitRateB = (parseFloat(b.declarePrice || 0) - parseFloat(b.costPrice || 0)) / (parseFloat(b.declarePrice || 0) || 1);
                            return profitRateA - profitRateB;
                        });
                        break;
                }
                
                productsGrid.innerHTML = '';
                sortedProducts.forEach(product => {
                    const productCard = createProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('排序失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>排序失败，请重试</p></div>';
            });
        }
        
        // 显示添加产品模态框
        function showAddProductModal() {
            const modal = document.getElementById('add-product-modal');
            modal.classList.add('show');
            
            // 清空表单
            document.getElementById('add-product-name').value = '';
            document.getElementById('add-product-spu').value = '';
            document.getElementById('add-product-skc').value = '';
            document.getElementById('add-product-sku').value = '';
            document.getElementById('add-product-category').value = '';
            document.getElementById('add-product-cost-price').value = '';
            document.getElementById('add-product-declare-price').value = '';
            document.getElementById('add-product-ad-bid-ratio').value = '';
            document.getElementById('add-product-description').value = '';
            document.getElementById('add-product-image-preview').innerHTML = '';
            
            // 绑定图片上传
            const imageUpload = document.getElementById('add-product-image-upload');
            const imageInput = document.getElementById('add-product-image-input');
            const imagePreview = document.getElementById('add-product-image-preview');
            
            imageUpload.onclick = () => imageInput.click();
            
            imageInput.onchange = (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                    };
                    reader.readAsDataURL(file);
                }
            };
            
            // 粘贴图片支持
            imageUpload.onpaste = (e) => {
                const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                for (let index in items) {
                    const item = items[index];
                    if (item.kind === 'file') {
                        const file = item.getAsFile();
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                        };
                        reader.readAsDataURL(file);
                    }
                }
            };
            
            // 保存按钮
            document.getElementById('save-product-btn').onclick = saveNewProduct;
        }
        
        // 保存新产品
        function saveNewProduct() {
            const product = {
                name: document.getElementById('add-product-name').value.trim(),
                spu: document.getElementById('add-product-spu').value.trim(),
                skc: document.getElementById('add-product-skc').value.trim(),
                sku: document.getElementById('add-product-sku').value.trim(),
                category: document.getElementById('add-product-category').value,
                costPrice: document.getElementById('add-product-cost-price').value || 0,
                declarePrice: document.getElementById('add-product-declare-price').value || 0,
                adBidRatio: document.getElementById('add-product-ad-bid-ratio').value || 0,
                description: document.getElementById('add-product-description').value.trim(),
                image: '',
                createdAt: new Date().toISOString()
            };
            
            // 获取图片
            const imageElement = document.querySelector('#add-product-image-preview img');
            if (imageElement) {
                product.image = imageElement.src;
            }
            
            // 验证必填项
            if (!product.name) {
                alert('请输入产品名称');
                return;
            }
            
            saveProduct(product).then(() => {
                alert('产品添加成功！');
                document.getElementById('add-product-modal').classList.remove('show');
                loadProducts();
            }).catch(error => {
                console.error('保存失败:', error);
                alert('保存失败，请重试');
            });
        }
        
        // 显示编辑产品模态框
        function showEditProductModal(id) {
            getProductById(id).then(product => {
                if (!product) {
                    alert('产品不存在');
                    return;
                }
                
                const modal = document.getElementById('edit-product-modal');
                modal.classList.add('show');
                
                // 填充表单
                document.getElementById('edit-product-name').value = product.name || '';
                document.getElementById('edit-product-spu').value = product.spu || '';
                document.getElementById('edit-product-skc').value = product.skc || '';
                document.getElementById('edit-product-sku').value = product.sku || '';
                document.getElementById('edit-product-category').value = product.category || '';
                document.getElementById('edit-product-cost-price').value = product.costPrice || '';
                document.getElementById('edit-product-declare-price').value = product.declarePrice || '';
                document.getElementById('edit-product-ad-bid-ratio').value = product.adBidRatio || '';
                document.getElementById('edit-product-description').value = product.description || '';
                
                // 显示图片预览
                const imagePreview = document.getElementById('edit-product-image-preview');
                if (product.image) {
                    imagePreview.innerHTML = `<img src="${product.image}" class="preview-image">`;
                } else {
                    imagePreview.innerHTML = '';
                }
                
                // 绑定图片上传
                const imageUpload = document.getElementById('edit-product-image-upload');
                const imageInput = document.getElementById('edit-product-image-input');
                
                imageUpload.onclick = () => imageInput.click();
                
                imageInput.onchange = (e) => {
                    const file = e.target.files[0];
                    if (file) {
                        const reader = new FileReader();
                        reader.onload = (event) => {
                            imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                        };
                        reader.readAsDataURL(file);
                    }
                };
                
                // 粘贴图片支持
                imageUpload.onpaste = (e) => {
                    const items = (e.clipboardData || e.originalEvent.clipboardData).items;
                    for (let index in items) {
                        const item = items[index];
                        if (item.kind === 'file') {
                            const file = item.getAsFile();
                            const reader = new FileReader();
                            reader.onload = (event) => {
                                imagePreview.innerHTML = `<img src="${event.target.result}" class="preview-image">`;
                            };
                            reader.readAsDataURL(file);
                        }
                    }
                };
                
                // 更新按钮
                document.getElementById('update-product-btn').onclick = () => updateProduct(id);
            }).catch(error => {
                console.error('获取产品失败:', error);
                alert('获取产品失败，请重试');
            });
        }
        
        // 更新产品
        function updateProduct(id) {
            const updatedProduct = {
                id,
                name: document.getElementById('edit-product-name').value.trim(),
                spu: document.getElementById('edit-product-spu').value.trim(),
                skc: document.getElementById('edit-product-skc').value.trim(),
                sku: document.getElementById('edit-product-sku').value.trim(),
                category: document.getElementById('edit-product-category').value,
                costPrice: document.getElementById('edit-product-cost-price').value || 0,
                declarePrice: document.getElementById('edit-product-declare-price').value || 0,
                adBidRatio: document.getElementById('edit-product-ad-bid-ratio').value || 0,
                description: document.getElementById('edit-product-description').value.trim(),
                updatedAt: new Date().toISOString()
            };
            
            // 获取图片
            const imageElement = document.querySelector('#edit-product-image-preview img');
            if (imageElement) {
                updatedProduct.image = imageElement.src;
            }
            
            // 验证必填项
            if (!updatedProduct.name) {
                alert('请输入产品名称');
                return;
            }
            
            saveProduct(updatedProduct).then(() => {
                alert('产品更新成功！');
                document.getElementById('edit-product-modal').classList.remove('show');
                loadProducts();
            }).catch(error => {
                console.error('更新失败:', error);
                alert('更新失败，请重试');
            });
        }
        
        // 复制产品
        function copyProduct(id) {
            getProductById(id).then(product => {
                if (!product) {
                    alert('产品不存在');
                    return;
                }
                
                // 创建新产品，不包含id和时间戳
                const newProduct = {
                    name: `${product.name} (副本)`,
                    spu: product.spu,
                    skc: product.skc,
                    sku: '', // 清空SKU，避免重复
                    category: product.category,
                    costPrice: product.costPrice,
                    declarePrice: product.declarePrice,
                    adBidRatio: product.adBidRatio,
                    description: product.description,
                    image: product.image,
                    createdAt: new Date().toISOString()
                };
                
                saveProduct(newProduct).then(() => {
                    alert('产品复制成功！');
                    loadProducts();
                }).catch(error => {
                    console.error('复制失败:', error);
                    alert('复制失败，请重试');
                });
            }).catch(error => {
                console.error('获取产品失败:', error);
                alert('获取产品失败，请重试');
            });
        }
        
        // 删除产品确认
        function deleteProductConfirm(id) {
            if (confirm('确定要删除这个产品吗？')) {
                deleteProduct(id).then(() => {
                    alert('产品删除成功！');
                    loadProducts();
                }).catch(error => {
                    console.error('删除失败:', error);
                    alert('删除失败，请重试');
                });
            }
        }
        
        // 显示批量删除模态框
        function showBatchDeleteModal() {
            if (confirm('确定要删除所有选中的产品吗？')) {
                // 这里应该获取选中的产品ID，简化处理
                alert('批量删除功能需要先选择产品');
            }
        }
        
        // 导出产品数据
        function exportProductData() {
            alert('导出功能需要引入ExcelJS或SheetJS库');
        }
        
        // 导入产品数据
        function importProductData() {
            const fileInput = document.createElement('input');
            fileInput.type = 'file';
            fileInput.accept = '.xlsx,.xls,.json';
            fileInput.onchange = (e) => {
                alert('导入功能需要引入ExcelJS或SheetJS库');
            };
            fileInput.click();
        }
        
        // 活动推广计算页面初始化
        function initPromotionCalculation() {
            console.log('初始化活动推广计算页面');
            loadPromotionProducts();
            bindPromotionEvents();
        }
        
        // 加载活动推广产品
        function loadPromotionProducts() {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">⏳</div><p>加载中...</p></div>';
            
            getAllProducts().then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = `
                        <div class="empty-state">
                            <div class="empty-state-icon">📊</div>
                            <p>暂无产品数据</p>
                            <button class="btn btn-primary add-product-btn">添加第一个产品</button>
                        </div>
                    `;
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createPromotionProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('加载产品失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>加载失败，请重试</p></div>';
            });
        }
        
        // 创建活动推广产品卡片
        function createPromotionProductCard(product) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.dataset.id = product.id;
            
            // 计算指标
            const metrics = calculatePromotionMetrics(product);
            
            card.innerHTML = `
                <img src="${product.image || 'https://via.placeholder.com/300x180?text=No+Image'}" alt="${product.name || '产品图片'}" class="product-image">
                <div class="product-info">
                    <div class="product-name">${product.name || '未命名产品'}</div>
                    <div class="product-details">
                        <div><span>SKU:</span> <span>${product.sku || '-'}</span></div>
                        <div><span>进货价格:</span> <span class="cost-price">¥${product.costPrice || '0.00'}</span></div>
                        <div><span>申报价格:</span> <span class="declare-price">¥${product.declarePrice || '0.00'}</span></div>
                        <div><span>广告出价比例:</span> <span>${product.adBidRatio || '0'}</span></div>
                    </div>
                    
                    <div class="activity-price-section">
                        <div><span>95折卖价:</span> <span>¥${metrics.sellPrice}</span></div>
                        <div><span>95折利润:</span> <span>¥${metrics.profit}</span></div>
                        <div><span>利润率:</span> <span>${metrics.profitRate}%</span></div>
                    </div>
                    
                    <div class="promotion-section">
                        <div><span>广告扣费:</span> <span>¥${metrics.adFee}</span></div>
                        <div><span>推广后利润:</span> <span>¥${metrics.promotionProfit}</span></div>
                    </div>
                </div>
                <div class="product-actions">
                    <button class="action-btn edit-btn" data-action="edit">编辑</button>
                    <button class="action-btn delete-btn" data-action="delete">删除</button>
                </div>
            `;
            
            // 绑定事件
            card.querySelector('[data-action="edit"]').addEventListener('click', () => showEditProductModal(product.id));
            card.querySelector('[data-action="delete"]').addEventListener('click', () => deleteProductConfirm(product.id));
            
            return card;
        }
        
        // 计算活动推广指标
        function calculatePromotionMetrics(product) {
            const declarePrice = parseFloat(product.declarePrice) || 0;
            const costPrice = parseFloat(product.costPrice) || 0;
            const adBidRatio = parseFloat(product.adBidRatio) || 1;
            
            // 95折卖价
            const sellPrice = (declarePrice * 0.95).toFixed(2);
            
            // 95折利润
            const profit = (sellPrice - costPrice).toFixed(2);
            
            // 利润率
            const profitRate = sellPrice > 0 ? ((profit / sellPrice) * 100).toFixed(1) : '0.0';
            
            // 广告扣费
            const adFee = adBidRatio > 0 ? (declarePrice / adBidRatio).toFixed(2) : '0.00';
            
            // 推广后利润
            const promotionProfit = (declarePrice - parseFloat(adFee) - costPrice).toFixed(2);
            
            return {
                sellPrice,
                profit,
                profitRate,
                adFee,
                promotionProfit
            };
        }
        
        // 绑定活动推广页面事件
        function bindPromotionEvents() {
            // 添加产品按钮
            document.querySelector('#promotion-calculation .add-product-btn').addEventListener('click', showAddProductModal);
            
            // 导出按钮
            document.getElementById('export-promotion-btn').addEventListener('click', exportPromotionProducts);
            
            // 导入按钮
            document.getElementById('import-promotion-btn').addEventListener('click', importProductData);
            
            // 搜索功能
            const searchBtn = document.querySelector('#promotion-calculation .search-row .btn-primary');
            const searchInput = document.querySelector('#promotion-calculation .search-input[placeholder="搜索产品名称、关键词..."]');
            
            searchBtn.addEventListener('click', () => {
                const keyword = searchInput.value.trim();
                if (keyword) {
                    searchProductsByKeywordPromotion(keyword);
                } else {
                    loadPromotionProducts();
                }
            });
            
            searchInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    searchBtn.click();
                }
            });
            
            // 排序功能
            const sortBtn = document.querySelector('#promotion-calculation .advanced-actions .btn:not(.btn-danger)');
            sortBtn.addEventListener('click', () => {
                const option = prompt('请选择排序方式:\n1. 利润降序\n2. 利润升序\n3. 推广后利润降序\n4. 推广后利润升序');
                
                switch (option) {
                    case '1':
                        sortPromotionProducts('profit', false);
                        break;
                    case '2':
                        sortPromotionProducts('profit', true);
                        break;
                    case '3':
                        sortPromotionProducts('promotionProfit', false);
                        break;
                    case '4':
                        sortPromotionProducts('promotionProfit', true);
                        break;
                }
            });
            
            // 批量删除
            const batchDeleteBtn = document.querySelector('#promotion-calculation .btn-danger');
            batchDeleteBtn.addEventListener('click', showBatchDeleteModal);
        }
        
        // 排序活动推广产品
        function sortPromotionProducts(sortBy, ascending) {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📊</div><p>排序中...</p></div>';
            
            getAllProducts().then(products => {
                // 计算每个产品的指标
                const productsWithMetrics = products.map(product => ({
                    product,
                    metrics: calculatePromotionMetrics(product)
                }));
                
                // 排序
                productsWithMetrics.sort((a, b) => {
                    let aValue = parseFloat(a.metrics[sortBy]);
                    let bValue = parseFloat(b.metrics[sortBy]);
                    
                    if (ascending) {
                        return aValue - bValue;
                    } else {
                        return bValue - aValue;
                    }
                });
                
                // 显示排序后的产品
                productsGrid.innerHTML = '';
                productsWithMetrics.forEach(item => {
                    const productCard = createPromotionProductCard(item.product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('排序失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>排序失败，请重试</p></div>';
            });
        }
        
        // 搜索活动推广产品
        function searchProductsByKeywordPromotion(keyword) {
            const productsGrid = document.querySelector('#promotion-calculation .products-grid');
            productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">🔍</div><p>搜索中...</p></div>';
            
            searchProducts(keyword).then(products => {
                productsGrid.innerHTML = '';
                
                if (products.length === 0) {
                    productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❓</div><p>未找到相关产品</p></div>';
                    return;
                }
                
                products.forEach(product => {
                    const productCard = createPromotionProductCard(product);
                    productsGrid.appendChild(productCard);
                });
            }).catch(error => {
                console.error('搜索失败:', error);
                productsGrid.innerHTML = '<div class="empty-state"><div class="empty-state-icon">❌</div><p>搜索失败，请重试</p></div>';
            });
        }
        
        // 导出活动推广产品
        function exportPromotionProducts() {
            alert('导出功能需要引入SheetJS库');
        }
        
        // 利润计算页面初始化
        function initProfitCalculation() {
            console.log('初始化利润计算页面');
            bindProfitEvents();
        }
        
        // 绑定利润计算页面事件
        function bindProfitEvents() {
            // 导入Excel按钮
            document.getElementById('import-profit-btn').addEventListener('click', importProfitExcel);
            
            // 导出结果按钮 (初始状态禁用)
            const exportResultBtn = document.getElementById('export-result-btn');
            exportResultBtn.disabled = true;
            exportResultBtn.addEventListener('click', exportCalculationResult);
            
            // 清空结果按钮
            document.getElementById('clear-result-btn').addEventListener('click', clearCalculationResult);
            
            // 拖拽上传
            const dropzone = document.getElementById('excel-dropzone');
            dropzone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '#e6f7ff';
            });
            
            dropzone.addEventListener('dragleave', () => {
                dropzone.style.backgroundColor = '';
            });
            
            dropzone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropzone.style.backgroundColor = '';
                
                if (e.dataTransfer.files.length) {
                    handleExcelFile(e.dataTransfer.files[0]);
                }
            });
            
            dropzone.addEventListener('click', () => {
                const fileInput = document.createElement('input');
                fileInput.type = 'file';
                fileInput.accept = '.xlsx,.xls';
                fileInput.onchange = (e) => {
                    if (e.target.files.length) {
                        handleExcelFile(e.target.files[0]);
                    }
                };
                fileInput.click();
            });
        }
        
        // 处理Excel文件
        function handleExcelFile(file) {
            if (!file.name.endsWith('.xlsx') && !file.name.endsWith('.xls')) {
                alert('请选择Excel文件 (.xlsx 或 .xls)');
                return;
            }
            
            // 模拟导入处理
            alert('Excel导入功能需要引入SheetJS库');
        }
        
        // 导入Excel进行利润计算
        function importProfitExcel() {
            alert('Excel导入功能需要引入SheetJS库');
        }
        
        // 导出计算结果
        function exportCalculationResult() {
            alert('导出功能需要引入SheetJS库');
        }
        
        // 清空计算结果
        function clearCalculationResult() {
            const resultContainer = document.getElementById('calculation-result');
            resultContainer.innerHTML = '<div class="empty-state"><div class="empty-state-icon">📊</div><p>请导入Excel文件进行利润计算</p></div>';
            
            // 禁用导出按钮
            document.getElementById('export-result-btn').disabled = true;
        }
        
        // 初始化应用
        function init() {
            initTabs();
            initProductManagement();
        }
        
        // 页面加载完成后初始化
        document.addEventListener('DOMContentLoaded', init);
    </script>
</body>
</html>